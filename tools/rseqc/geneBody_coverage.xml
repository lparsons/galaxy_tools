<tool id="rseqc_geneBody_coverage" name="Gene Body Converage (BAM)" version="2.4galaxy1">
    <description>
        Read coverage over gene body.
    </description>

    <macros>
        <import>rseqc_macros.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="3.0.3">R</requirement>
        <requirement type="package" version="1.7.1">numpy</requirement>
        <requirement type="package" version="2.4">rseqc</requirement>
    </requirements>

    <stdio>
        <exit_code range="1:" level="fatal" description="An error occured during execution, see stderr and stdout for more information" />
        <regex match="[Ee]rror" source="both" description="An error occured during execution, see stderr and stdout for more information" />
    </stdio>

    <version_command><![CDATA[geneBody_coverage.py --version]]></version_command>

    <command><![CDATA[
        #set $safename = ''.join(c in '_0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' and c or '_' for c in $input.display_name)
        #set $fname = "d1_" + str($safename) + ".bam"
        ln -s '${input}' '${fname}' &&
        ln -s '${input.metadata.bam_index}' '${fname}.bai' &&
        echo '${fname}' > input_list.txt &&
        #for $i, $additional_input in enumerate($additionalinputs):
            #set $index = $i+2
            #set $safename = ''.join(c in '_0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ' and c or '_' for c in $additional_input.file.display_name)
            #set $fname = 'd' + str($index) + '_' + str($safename) + ".bam"
            ln -s '$additional_input.file' '${fname}' &&
            ln -s '$additional_input.file.metadata.bam_index' '${fname}.bai' &&
            echo '${fname}' >> input_list.txt &&
        #end for
        geneBody_coverage.py -i input_list.txt -r $refgene --minimum_length $minimum_length -o output
        ]]>
    </command>

    <inputs>
        <param name="input" type="data" label="Additional input .bam files" format="bam" />
        <repeat name="additionalinputs" title="Input .bam file">
            <param name="file" type="data" label="Input .bam file" format="bam" />
        </repeat>
        <param name="refgene" type="data" label="Reference Genome" format="bed" />
        <param name="minimum_length" type="integer" value="100" label="Minimum mRNA length" help="Minimum mRNA length (bp). mRNA that are shorter than this value will be skipped (default is 100)." />
    </inputs>

    <outputs>
        <data name="outputcurvespdf" format="pdf" from_work_dir="output.geneBodyCoverage.curves.pdf" label="${tool.name} on ${on_string} (Curves PDF)" />
        <data name="outputheatmappdf" format="pdf" from_work_dir="output.geneBodyCoverage.heatMap.pdf" label="${tool.name} on ${on_string} (HeatMap PDF)">
            <filter>len(additionalinputs) >= 2</filter>
        </data>
        <data name="outputr" format="txt" from_work_dir="output.geneBodyCoverage.r" label="${tool.name} on ${on_string} (R Script)" />
        <data name="outputtxt" format="txt" from_work_dir="output.geneBodyCoverage.txt" label="${tool.name} on ${on_string} (Text)" />
    </outputs>

    <tests>
        <test>
            <param name="input" value="pairend_strandspecific_51mer_hg19_chr1_1-100000.bam"/>
            <param name="refgene" value="hg19_RefSeq_chr1_1-100000.bed"/>
            <output name="outputcurvespdf" file="output.geneBodyCoverage.curves.pdf"/>
            <output name="outputr" file="output.geneBodyCoverage.r"/>
            <output name="outputtxt" file="output.geneBodyCoverage.txt"/>
        </test>
        <test>
            <param name="input" value="pairend_strandspecific_51mer_hg19_chr1_1-100000.bam"/>
            <param name="file_0" value="pairend_strandspecific_51mer_hg19_chr1_1-100000.bam"/>
            <param name="file_1" value="pairend_strandspecific_51mer_hg19_chr1_1-100000.bam"/>
            <param name="refgene" value="hg19_RefSeq_chr1_1-100000.bed"/>
            <output name="outputcurvespdf" file="output2.geneBodyCoverage.curves.pdf"/>
            <output name="outputcurvespdf" file="output2.geneBodyCoverage.heatMap.pdf"/>
            <output name="outputr" file="output2.geneBodycoverage.r"/>
            <output name="outputtxt" file="output2.geneBodyCoverage.txt"/>
        </test>

    </tests>

    <help><![CDATA[
geneBody_coverage.py
++++++++++++++++++++

Read coverage over gene body. This module is used to check if read coverage is uniform and if there is any 5\'/3\' bias. This module scales all transcripts to 100 nt and calculates the number of reads covering each nucleotide position. Finally, it generates plots illustrating the coverage profile along the gene body.

If 3 or more BAM files were provided. This program generates a lineGraph and a heatmap. If fewer than 3 BAM files were provided, only lineGraph is generated. See below for examples.

When heatmap is generated, samples are ranked by the "skewness" of the coverage: Sample with best (worst) coverage will be displayed at the top (bottom) of the heatmap.
Coverage skewness was measured by `Pearsonâ€™s skewness coefficients &lt;http://en.wikipedia.org/wiki/Skewness#Pearson.27s_skewness_coefficients>`_

Inputs
++++++++++++++

Input BAM/SAM file
	Alignment file in BAM/SAM format.

Reference gene model
	Gene Model in BED format.

Minimum mRNA length
    Minimum mRNA length (bp). mRNA that are shorter than this value will be skipped (default is 100).

Outputs
++++++++++++++
Text
    Table that includes the data used to generate the plots

R Script
    R script file that reads the data and generates the plot

PDF
    The final plot, in PDF format

Example plots:
    .. image:: http://rseqc.sourceforge.net/_images/Aug_26.geneBodyCoverage.curves.png
        :height: 600 px
        :width: 600 px
        :scale: 80 %

    .. image:: http://rseqc.sourceforge.net/_images/Aug_26.geneBodyCoverage.heatMap.png
        :height: 600 px
        :width: 600 px
        :scale: 80 %

-----

]]>
        <expand macro="about" />
    </help>

    <expand macro="citations" />

</tool>
